<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>영구 저장 로컬 플레이어</title>
    <style>
        :root { --primary: #00d2ff; --bg: #0f2027; --card: #203a43; --text: #ffffff; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; display: flex; justify-content: center; padding: 20px; }
        .player-card { background: var(--card); padding: 30px; border-radius: 15px; width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .status { font-size: 0.8rem; color: var(--primary); margin-bottom: 10px; height: 1rem; }
        
        /* 리스트 스타일 */
        .playlist { 
            margin-top: 20px; max-height: 300px; overflow-y: auto; 
            background: rgba(0,0,0,0.2); border-radius: 10px; padding: 10px;
        }
        .song-item { 
            padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); 
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .song-item:hover { background: rgba(255,255,255,0.1); }
        .song-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9rem; }
        
        .controls { display: flex; gap: 10px; margin-top: 20px; align-items: center; }
        button { cursor: pointer; background: var(--primary); border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; }
        .delete-all { background: #ff4b2b; color: white; font-size: 0.7rem; margin-top: 10px; }
        
        #audio { width: 100%; margin-top: 20px; filter: invert(1); }
    </style>
</head>
<body>

<div class="player-card">
    <h3>My Local Jukebox</h3>
    <div id="status" class="status">시스템 준비됨</div>
    
    <input type="file" id="fileInput" multiple accept="audio/*" webkitdirectory>
    
    <audio id="audio" controls></audio>
    
    <div class="playlist" id="playlist">
        <div style="text-align: center; color: #888;">추가된 곡이 없습니다.</div>
    </div>

    <button class="delete-all" onclick="clearAllData()">모든 데이터 초기화</button>
</div>

<script>
    const dbName = "PermanentMusicDB";
    const storeName = "songs";
    let db;

    // 1. 데이터베이스 연결 (영구 저장 설정)
    const request = indexedDB.open(dbName, 1);
    request.onupgradeneeded = (e) => {
        db = e.target.result;
        if (!db.objectStoreNames.contains(storeName)) {
            db.createObjectStore(storeName, { keyPath: "name" });
        }
    };
    request.onsuccess = (e) => {
        db = e.target.result;
        updateStatus("데이터 로드 완료");
        displayPlaylist();
    };

    // 2. 파일 저장 로직 (핵심: ArrayBuffer로 변환하여 DB에 박기)
    document.getElementById('fileInput').onchange = async (e) => {
        const files = Array.from(e.target.files);
        updateStatus(`${files.length}개의 파일을 처리 중...`);

        for (const file of files) {
            if (!file.type.startsWith('audio/')) continue;

            const reader = new FileReader();
            reader.onload = (ev) => {
                const transaction = db.transaction([storeName], "readwrite");
                const store = transaction.objectStore(storeName);
                
                store.put({
                    name: file.name,
                    data: ev.target.result, // 실제 파일 바이너리 데이터
                    type: file.type
                });

                transaction.oncomplete = () => {
                    displayPlaylist();
                };
            };
            reader.readAsArrayBuffer(file);
        }
        updateStatus("모든 곡 저장 완료!");
    };

    // 3. 리스트 출력
    function displayPlaylist() {
        const transaction = db.transaction([storeName], "readonly");
        const store = transaction.objectStore(storeName);
        const request = store.getAll();

        request.onsuccess = () => {
            const songs = request.result;
            const container = document.getElementById('playlist');
            container.innerHTML = '';

            if (songs.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #888;">목록이 비어있습니다.</div>';
                return;
            }

            songs.forEach(song => {
                const div = document.createElement('div');
                div.className = 'song-item';
                div.innerHTML = `<span class="song-name">${song.name}</span>`;
                div.onclick = () => playSong(song);
                container.appendChild(div);
            });
        };
    }

    // 4. 재생 (DB에서 꺼내서 URL로 변환)
    function playSong(song) {
        const audio = document.getElementById('audio');
        const blob = new Blob([song.data], { type: song.type });
        const url = URL.createObjectURL(blob);
        
        audio.src = url;
        audio.play();
        updateStatus(`재생 중: ${song.name}`);
    }

    function updateStatus(msg) {
        document.getElementById('status').innerText = msg;
    }

    // 5. 초기화 기능 (지우고 싶을 때)
    function clearAllData() {
        if (confirm("정말 모든 음악 데이터를 지우시겠습니까?")) {
            const transaction = db.transaction([storeName], "readwrite");
            transaction.objectStore(storeName).clear();
            transaction.oncomplete = () => {
                location.reload();
            };
        }
    }
</script>

</body>
</html>
